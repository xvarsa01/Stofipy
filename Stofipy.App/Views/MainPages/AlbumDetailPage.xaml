<?xml version="1.0" encoding="utf-8"?>

<views:ContentViewBase
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:models="clr-namespace:Stofipy.BL.Models;assembly=Stofipy.BL"
    xmlns:views="clr-namespace:Stofipy.App.Views"
    xmlns:viewModels="clr-namespace:Stofipy.App.ViewModels.Album"
    xmlns:components="clr-namespace:Stofipy.App.Components"
    xmlns:converters="clr-namespace:Stofipy.App.Converters"
    x:Class="Stofipy.App.Views.MainPages.AlbumDetailPage"
    x:Name="Root"
    x:DataType="viewModels:AlbumDetailVM"
    >
    
    <ContentView.Resources>
        <converters:FileBackgroundColorConverter x:Key="FileBgColorConverter" />
    </ContentView.Resources>


    <!-- Main Middle -->
    <ScrollView>
    <Grid BackgroundColor="{StaticResource PagesBg}">
        <components:BackgroundGradient Picture="{Binding Album.Picture}"/>

        <VerticalStackLayout
            Padding="0, 20, 0, 0"
            Spacing="10">

            <!-- playlist details -->
            <Grid
                ColumnDefinitions="auto, auto"
                Padding="20,0">
                
                <Image 
                    Grid.Column="0" 
                    Source="{Binding Album.Picture}"
                    Aspect="AspectFill"
                    HeightRequest="150"
                    WidthRequest="150"/>
                <VerticalStackLayout
                    Grid.Column="1"
                    Spacing="5"
                    VerticalOptions="End"
                    Padding="10,0,0,20">
                    <Label
                        HorizontalOptions="Start"
                        Text="Album"
                        TextColor="White"
                        FontSize="15"/>
                    <Label
                        HorizontalOptions="Start"
                        Text="{Binding Album.AlbumName}"
                        TextColor="White"
                        FontSize="50"
                        FontFamily="FuturaBold"
                        FontAttributes="Bold"
                        />
                    <Label
                        HorizontalOptions="Start"
                        Text="{Binding Album.LengthFormatted}"
                        TextColor="White"
                        FontSize="15"/>
                </VerticalStackLayout>
                
            </Grid>
        
            <!-- TODO Change minimal height request to dynamic-->
            <Grid VerticalOptions="Fill"
                  MinimumHeightRequest="700">
            <BoxView Opacity="0.25"
                     Color="Black"/>
            <VerticalStackLayout
                Padding="20"
                Spacing="20">
                        
                <!-- buttons -->
                <Grid
                    ColumnDefinitions="auto, auto, auto, *, auto"
                    ColumnSpacing="10">
                
                    <components:PlayPauseButtonGreen
                        ButtonPressedCommand="{Binding Source={x:Reference Root}, Path=BindingContext.PlayAlbumCommand}"
                        MusicIsPlaying="{Binding ThisAlbumIsPlaying}"/>
                    <Button Grid.Column="1" Text="Shuffle" />
                    <Button Grid.Column="2" Text="Download" />
                    <SearchBar Grid.Column="3" Text="Search"/>
                    <Button Grid.Column="4" Text="Sort" />
                </Grid>
                
                <!-- songs in album -->
                <CollectionView
                                ItemsSource="{Binding Files}">
                    <CollectionView.Header>
                        <Grid ColumnDefinitions="30, *, *, auto"
                              Padding="20,5">
                            <Label Grid.Column="0" VerticalOptions="Center" HorizontalOptions="Start" TextColor="White" Text="#" />
                            <Label Grid.Column="1" VerticalOptions="Center" HorizontalOptions="Start" TextColor="White" Text="Title" />
                            <Label Grid.Column="2" VerticalOptions="Center" HorizontalOptions="Start" TextColor="White" Text="Plays" />
                            <Label Grid.Column="3" VerticalOptions="Center" HorizontalOptions="Start" TextColor="White" Text="⏱" />
                        </Grid>
                    </CollectionView.Header>
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:FilesInAlbumModel">
                            <components:RowOfAlbumComponent ComponentId="{Binding FileId}"
                                                            IndexText="{Binding Index}"
                                                            TopText="{Binding FileName}"
                                                            BottomText="{Binding Source={x:Reference Root}, Path=BindingContext.Album.AuthorName}"
                                                            PlayCountText="{Binding PlayCount}"
                                                            DurationText="{Binding LengthFormatted}"
                                                            
                                                            TapCommand="{Binding Source={x:Reference Root}, Path=BindingContext.SelectRowCommand}" 
                                                            CommandParameter="{Binding .}"
                                                            BottomTextTapCommand="{Binding Source={x:Reference Root}, Path=BindingContext.GoToAuthorCommand}"
                                                            IsSelected="{Binding IsSelected}"
                                                            PlayClickedCommand="{Binding Source={x:Reference Root}, Path=BindingContext.PlayItemCommand}" 
                                                            />
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
                
                <components:SectionTitleWithShowAll
                    TitleText="{Binding Album.AuthorName, StringFormat='{} More by {0}'}"
                    RightText="See discography"/>
                
                <CollectionView ItemsSource="{Binding MoreAlbumsFromAuthor}">
                    <CollectionView.ItemsLayout>
                        <GridItemsLayout Orientation="Horizontal" />
                    </CollectionView.ItemsLayout>
                    
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:AlbumListModel">
                            <components:FileBigWith2Texts
                                Picture="{Binding Picture}"
                                TopText="{Binding AlbumName}"
                                BottomText="{Binding Year, StringFormat='{}{0} · Album'}"
                                PlayCommand="{Binding Source={x:Reference Root}, Path=BindingContext.PlayOtherAlbumFromAuthorCommand}"
                                TapCommand="{Binding Source={x:Reference Root}, Path=BindingContext.GoToOtherAlbumFromAuthorCommand}"
                                CommandParameter="{Binding Id}"
                            />
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </VerticalStackLayout>
            </Grid>
            
        </VerticalStackLayout>
    </Grid>
    </ScrollView>

</views:ContentViewBase>